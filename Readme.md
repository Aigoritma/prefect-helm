# Prefect Server Helm Chart

## Usage


### Installing released versions

The Helm chart is automatically versioned and released alongside Server.
For each Github Release of Server there is a corresponding version of the Helm chart.
The charts are hosted in a [Helm repository](https://helm.sh/docs/chart_repository/) deployed to the web courtesy of Github Pages.

1. Let you local Helm manager know about the repository.

    ```
    $ helm repo add prefecthq https://prefecthq.github.io/server/
    ```

2. Sync versions available in the repo to your local cache.

    ```
    $ helm repo update
    ```

3. Search for available charts and versions

    ```
    $ helm search repo [name]
    ```

4. Install the Helm chart

    Using default options
    ```
    $ helm install prefecthq/prefect-server --generate-name
    ```

    Setting some typical flags for customization
    ```shell
    # The kubernetes namespace to install into, can be anything or excluded to install in the default namespace
    NAMESPACE=prefect-server
    # The Helm "release" name, can be anything but we recommend matching the chart name
    NAME=prefect-server
    # The path to your config that overrides values in `values.yaml`
    CONFIG_PATH=path/to/your/config.yaml
    # The chart version to install
    VERSION=2022.04.14

    helm install \
        --namespace $NAMESPACE \
        --version $VERSION \
        --values $CONFIG_PATH \
        $NAME \
        prefecthq/prefect-server
    ```

    _If chart installation fails, `--debug` can provide more information_

    See [Helm install docs](https://helm.sh/docs/helm/helm_install/) for all options.

### Installing development versions

Development versions of the Helm chart will always be available directly from this Github repository.

1. Clone repository

2. Change to this directory

3. Download the postgresql dependency if you are not using an existing database

    ```
    $ helm dependency update
    ```

4. Install the chart

    ```
    $ helm install . --generate-name
    ```

### Upgrading

1. Look up the name of the last release

    ```
    $ helm list
    ```

2. Run the upgrade

    ```shell
    # Set this name to the name of your last Helm release
    NAME=orion
    # Choose a version to upgrade to or omit the flag to use the latest version
    VERSION=0.0.1

    helm upgrade $NAME prefecthq/prefect-helm --version $VERSION
    ```

    For development versions, make sure your cloned repository is updated (`git pull`) and reference the local chart
    ```
    $ helm upgrade $NAME .
    ```

3. Upgrades can also be used enable features or change options

    ```shell
    NAME=orion

    helm upgrade \
        $NAME \
        prefecthq/prefect-helm \
        --set agent.enabled=true \
        --set jobs.createTenant.enabled=true
    ```

#### Important notes about upgrading

- Updates will only update infrastructure that is modified.
- You will need to continue to set any values that you set during the original install (e.g. `--set agent.enabled=true` or `--values path/to/config.yaml`).
- If you are using the postgresql subchart with an autogenerated password, it will complain that you have not provided that password for the upgrade.
  Export the password as the error asks then set it within the subchart using
    ```
    $ helm upgrade ... --set postgresql.postgresqlPassword=$POSTGRESQL_PASSWORD
    ```

## Options:

See comments in `values.yaml`.

```shell
kubectl create secret generic prefect-postgresql-pwd --from-literal='postgresql-password=YOUR_POSTGRES_PWD'
```

Then, add the flag `--set postgresql.existingSecret=prefect-postgresql-pwd` to the helm install command to use this secret to connect to your database.

Note that the argument `postgresqlPassword` will be ignored in this case. This argument is only relevant when using the Postgres database included in the chart. For an external database, you must create and use `existingSecret` instead of `postgresqlPassword`.

An external database will require some minimal setup for Hasura.
The following needs to be run or the user should have permissions to execute it and Hasura will run it on startup:

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
SET TIME ZONE 'UTC';
```

### Ingress

Ingress rule creation is suported for `api` components of this chart. You must have an Ingress controller (i.e. nginx) installed to your cluster and configured independently of this chart.

To create an Ingress rule for a component,
1. Disable direct service access by setting `api.service.type` to `ClusterIP` instead of `LoadBalancer`
2. Enable the Ingress by setting `api.ingress.enabled` to `true`
3. Configuring the list of hosts at `api.ingress.hosts` to include your domains. _There is an example in values.yaml_ 

Created component Ingress rules will be automatically configured to forward traffic from specified hosts to coresponding services.

You can secure an Ingress by specifying a `Secret` that contains a TLS private key and certificate. For information how to setup the secret, refer to the [Ingress section of the official Kubernetes documentation](https://kubernetes.io/docs/concepts/services-networking/ingress/#tls).

## Versioning

## Configure the Orion API on Kubernetes

To interact with the Prefect Orion API running in Kubernetes, we need to make sure of two things:

- The `prefect` command knows to talk to the Orion API running in Kubernetes
- We can visit the Orion UI running in Kubernetes

### Forward ports

First, use the `kubectl port-forward` command to forward a port on your local machine to an open port within the cluster. 

```bash
$ kubectl port-forward deployment/orion 4200:4200
```
This forwards port 4200 on the default internal loop IP for localhost to the “orion” deployment. You’ll see output like this:

```
$ kubectl port-forward deployment/orion 4200:4200 Forwarding from 127.0.0.1:4200 -> 4200 Forwarding from [::1]:4200 -> 4200 Handling connection for 4200
```

Keep this command running, and open a new terminal for the next commands. Make sure you change to the same directory as you were previously using and activate your Python virtual environment, if you're using one.

### Configure the API URL
Now we need to tell our local prefect command how to communicate with the Orion API running in Kubernetes.

In the new terminal session, run the prefect config view command to see your current Prefect settings. We're particularly interested in PREFECT_API_URL.

``` 
$ prefect config view PREFECT_PROFILE='default' PREFECT_API_URL='http://127.0.0.1:4200/api' 
```
If your `PREFECT_API_URL` is currently set to 'http://127.0.0.1:4200/api' or 'http://localhost:4200/api', great! Prefect is configured to communicate with the API at the address we're forwarding, so you can go to the next step.

If `PREFECT_API_URL` is not set as shown above, run the following Prefect CLI command to configure it for this tutorial:

```
prefect config set PREFECT_API_URL=http://127.0.0.1:4200/api
```

Since we previously configured port forwarding for the localhost port to the Kubernetes environment, we’ll be able to interact with the Orion API running in Kubernetes when using local Prefect CLI commands.

### FAQ
Q: `No work queue found named 'kubernetes'` 
> Don't worry about the `No work queue found named 'kubernetes'` warning here. A new Prefect Orion API server does not start with a default work queue from which the agent can pick up work. We'll create the work queue in a future step.